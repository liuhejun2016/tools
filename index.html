<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“è·¯æ¨™è­˜æŠ½å‡ºãƒ„ãƒ¼ãƒ« - è‡ªå‹•æ¤œå‡º & åå‰ç·¨é›†</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f8f9ff 0%, #eef1ff 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #0f3460 0%, #2d4059 100%);
            color: white;
            padding: 35px 50px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 1px;
        }
        
        header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 900px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .main-content {
            padding: 35px;
        }
        
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }
        
        .upload-card, .settings-card {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }
        
        .card-title {
            color: #0f3460;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e6ff;
            font-size: 1.4rem;
        }
        
        .upload-area {
            border: 3px dashed #4a6bff;
            border-radius: 12px;
            padding: 50px 25px;
            text-align: center;
            background: #f0f3ff;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .upload-area:hover {
            background: #e8ebff;
            border-color: #2d4bff;
            transform: translateY(-3px);
        }
        
        .upload-icon {
            font-size: 3.5rem;
            color: #4a6bff;
            margin-bottom: 20px;
        }
        
        .upload-area h3 {
            color: #0f3460;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }
        
        .selected-file {
            margin-top: 20px;
            padding: 12px;
            background: #e8f4ff;
            border-radius: 8px;
            border-left: 4px solid #4a6bff;
        }
        
        .settings-group {
            margin-bottom: 20px;
        }
        
        .slider-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            color: #0f3460;
        }
        
        .slider-value {
            color: #4a6bff;
            font-weight: bold;
        }
        
        input[type="range"] {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: #e0e6ff;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4a6bff;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(74, 107, 255, 0.4);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #4a6bff;
        }
        
        .checkbox-group label {
            font-weight: 500;
            color: #0f3460;
        }
        
        .status-panel {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: none;
        }
        
        .status-panel.active {
            display: block;
        }
        
        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status-title {
            color: #0d47a1;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .status-progress {
            color: #4a6bff;
            font-weight: bold;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e0e6ff;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a6bff, #6a8bff);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 6px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 50px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 180px;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4a6bff 0%, #6a8bff 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(74, 107, 255, 0.3);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(74, 107, 255, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.3);
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 184, 148, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #fdcb6e 0%, #ffeaa7 100%);
            color: #333;
            box-shadow: 0 6px 20px rgba(253, 203, 110, 0.3);
        }
        
        .btn-warning:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(253, 203, 110, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff7675 0%, #fab1a0 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(255, 118, 117, 0.3);
        }
        
        .btn-danger:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(255, 118, 117, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #00cec9 0%, #81ecec 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(0, 206, 201, 0.3);
        }
        
        .btn-info:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 206, 201, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .content-area {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 30px;
            height: 700px;
        }
        
        @media (max-width: 1200px) {
            .content-area {
                grid-template-columns: 1fr;
                height: auto;
            }
        }
        
        .pdf-section, .icons-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .section-title {
            color: #0f3460;
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .canvas-wrapper {
            flex: 1;
            position: relative;
            border: 2px solid #e0e6ff;
            border-radius: 12px;
            overflow: auto;
            background: #fafbff;
            min-height: 500px;
        }
        
        #pdf-canvas {
            display: block;
            cursor: crosshair;
        }
        
        /* é¸æŠãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
        .selection-box {
            position: absolute;
            border: 3px solid #ff0000;
            background: rgba(255, 0, 0, 0.08);
            pointer-events: auto;
            z-index: 10;
            border-radius: 6px;
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8), 
                        0 0 15px rgba(255, 0, 0, 0.3);
            transition: all 0.2s ease;
        }
        
        .selection-box.active {
            border: 3px solid #00ff00 !important;
            background: rgba(0, 255, 0, 0.08) !important;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9), 
                        0 0 20px rgba(0, 255, 0, 0.5);
            z-index: 11;
        }
        
        .selection-box.fixed {
            border: 3px solid #4a6bff !important;
            background: rgba(74, 107, 255, 0.08) !important;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9), 
                        0 0 15px rgba(74, 107, 255, 0.4);
        }
        
        .selection-box.completed {
            border: 3px solid #00b894 !important;
            background: rgba(0, 184, 148, 0.08) !important;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9), 
                        0 0 15px rgba(0, 184, 148, 0.4);
        }
        
        .selection-controls {
            position: absolute;
            top: -35px;
            left: 0;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 12;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .selection-btn {
            padding: 3px 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .selection-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .selection-btn.fix {
            background: #4a6bff;
        }
        
        .selection-btn.complete {
            background: #00b894;
        }
        
        .selection-btn.delete {
            background: #ff6b6b;
        }
        
        .selection-handle {
            position: absolute;
            width: 14px;
            height: 14px;
            background: #ff0000;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 3px rgba(0,0,0,0.5);
            pointer-events: auto;
            cursor: pointer;
            z-index: 13;
        }
        
        .selection-box.active .selection-handle {
            background: #00ff00;
        }
        
        .selection-box.fixed .selection-handle {
            background: #4a6bff;
        }
        
        .selection-box.completed .selection-handle {
            background: #00b894;
        }
        
        .selection-handle.nw { top: -7px; left: -7px; cursor: nw-resize; }
        .selection-handle.ne { top: -7px; right: -7px; cursor: ne-resize; }
        .selection-handle.sw { bottom: -7px; left: -7px; cursor: sw-resize; }
        .selection-handle.se { bottom: -7px; right: -7px; cursor: se-resize; }
        .selection-handle.n { top: -7px; left: 50%; margin-left: -7px; cursor: n-resize; }
        .selection-handle.s { bottom: -7px; left: 50%; margin-left: -7px; cursor: s-resize; }
        .selection-handle.e { top: 50%; right: -7px; margin-top: -7px; cursor: e-resize; }
        .selection-handle.w { top: 50%; left: -7px; margin-top: -7px; cursor: w-resize; }
        
        .selection-info {
            position: absolute;
            bottom: -25px;
            left: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 12;
            pointer-events: none;
        }
        
        .selection-counter {
            position: absolute;
            top: -12px;
            left: -12px;
            background: #ff0000;
            color: white;
            font-size: 12px;
            font-weight: bold;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 14;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        .selection-box.active .selection-counter {
            background: #00ff00;
        }
        
        .selection-box.fixed .selection-counter {
            background: #4a6bff;
        }
        
        .selection-box.completed .selection-counter {
            background: #00b894;
        }
        
        .global-controls {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            border: 2px solid #e0e6ff;
        }
        
        .global-controls-title {
            font-weight: 600;
            color: #0f3460;
            font-size: 1.1rem;
        }
        
        .global-btn {
            padding: 10px 20px;
            background: #4a6bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .global-btn:hover {
            background: #3a5bef;
        }
        
        .global-btn.extract {
            background: #00b894;
        }
        
        .global-btn.extract:hover {
            background: #00a884;
        }
        
        .global-btn.clear {
            background: #ff6b6b;
        }
        
        .global-btn.clear:hover {
            background: #ff5252;
        }
        
        .global-btn.auto {
            background: #00cec9;
        }
        
        .global-btn.auto:hover {
            background: #00b4b0;
        }
        
        .selection-stats {
            margin-left: auto;
            font-size: 14px;
            color: #666;
            display: flex;
            gap: 15px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stat-badge {
            background: #4a6bff;
            color: white;
            font-size: 11px;
            font-weight: bold;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stat-badge.active { background: #00ff00; }
        .stat-badge.fixed { background: #4a6bff; }
        .stat-badge.completed { background: #00b894; }
        
        .icon-grid-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 500px;
        }
        
        .icon-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 20px;
            padding: 15px;
            overflow-y: auto;
            background: #fafbff;
            border-radius: 10px;
            max-height: 550px;
        }
        
        .icon-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .icon-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #4a6bff;
        }
        
        .icon-item.selected {
            border-color: #ff6b8b;
            background: linear-gradient(135deg, #fff5f7 0%, #ffeef1 100%);
        }
        
        .icon-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 10px;
            image-rendering: -webkit-optimize-contrast;
        }
        
        .icon-name-container {
            width: 100%;
            margin-top: 5px;
        }
        
        .icon-name-display {
            font-size: 12px;
            color: #666;
            font-weight: 500;
            margin-bottom: 5px;
            min-height: 18px;
            word-break: break-word;
            padding: 2px 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .icon-item:hover .icon-name-display {
            background-color: #f0f3ff;
        }
        
        .icon-name-input {
            width: 100%;
            padding: 5px 8px;
            border: 2px solid #4a6bff;
            border-radius: 6px;
            font-size: 12px;
            font-family: inherit;
            background: white;
            color: #333;
            display: none;
            margin-bottom: 5px;
        }
        
        .icon-name-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.2);
        }
        
        .icon-name-edit-btn {
            background: #4a6bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 11px;
            cursor: pointer;
            display: none;
            margin-top: 5px;
            transition: all 0.2s;
        }
        
        .icon-item:hover .icon-name-edit-btn {
            display: inline-block;
        }
        
        .icon-name-edit-btn:hover {
            background: #3a5bef;
        }
        
        .icon-name-edit-btn.save {
            background: #00b894;
        }
        
        .icon-name-edit-btn.save:hover {
            background: #00a884;
        }
        
        .icon-name-edit-btn.cancel {
            background: #ff6b6b;
        }
        
        .icon-name-edit-btn.cancel:hover {
            background: #ff5252;
        }
        
        .icon-size {
            font-size: 10px;
            color: #888;
            margin-top: 3px;
        }
        
        .icon-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #4a6bff;
            color: white;
            font-size: 11px;
            font-weight: bold;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 80px 20px;
            color: #999;
        }
        
        .empty-icon {
            font-size: 5rem;
            margin-bottom: 25px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            color: #666;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .icon-detail-panel {
            background: linear-gradient(135deg, #f8f9ff 0%, #eef1ff 100%);
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
            display: none;
        }
        
        .icon-detail-panel.active {
            display: block;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .detail-title {
            color: #0f3460;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .detail-content {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 25px;
            align-items: start;
        }
        
        .detail-preview {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .detail-preview-img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            margin-bottom: 15px;
        }
        
        .detail-info {
            padding: 10px;
        }
        
        .detail-info-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed #e0e0e0;
        }
        
        .detail-label {
            font-weight: 600;
            color: #0f3460;
            display: block;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: #555;
            font-size: 0.95rem;
        }
        
        .detail-name-edit {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        
        .detail-name-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #4a6bff;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .detail-name-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.2);
        }
        
        .detail-name-btn {
            padding: 8px 16px;
            background: #4a6bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .detail-name-btn:hover {
            background: #3a5bef;
        }
        
        .detail-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .detail-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .detail-btn-primary {
            background: #4a6bff;
            color: white;
        }
        
        .detail-btn-primary:hover {
            background: #3a5bef;
        }
        
        .hint-box {
            background: #e8f4ff;
            border-left: 4px solid #4a6bff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 25px;
        }
        
        .hint-title {
            color: #0f3460;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .hint-content {
            color: #555;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        footer {
            text-align: center;
            padding: 25px;
            color: #666;
            border-top: 1px solid #eee;
            margin-top: 35px;
            background: #f8f9ff;
        }
        
        .zoom-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 20;
            display: flex;
            gap: 10px;
        }
        
        .zoom-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: #f0f3ff;
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            color: #4a6bff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .zoom-btn:hover {
            background: #4a6bff;
            color: white;
        }
        
        .zoom-level {
            min-width: 60px;
            text-align: center;
            line-height: 36px;
            font-weight: 600;
            color: #0f3460;
        }
        
        .batch-name-edit {
            background: #fff9e6;
            border: 2px solid #fdcb6e;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .batch-name-label {
            font-weight: 600;
            color: #e17055;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .batch-name-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #fdcb6e;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .batch-name-btn {
            padding: 8px 16px;
            background: #fdcb6e;
            color: #333;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .batch-name-btn:hover {
            background: #f7b74f;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš¦ é“è·¯æ¨™è­˜æŠ½å‡ºãƒ„ãƒ¼ãƒ« - è‡ªå‹•æ¤œå‡º & åå‰ç·¨é›†</h1>
            <div class="subtitle">
                è‡ªå‹•æ¤œå‡ºãƒœã‚¿ãƒ³ã§ä¸€æ‹¬é¸æŠãƒœãƒƒã‚¯ã‚¹ä½œæˆ â†’ å€‹åˆ¥èª¿æ•´ â†’ åå‰å…¥åŠ› â†’ ä¸€æ‹¬æŠ½å‡ºï¼
            </div>
        </header>
        
        <div class="main-content">
            <div class="control-panel">
                <div class="upload-card">
                    <h2 class="card-title">ğŸ“„ PDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                    <div class="upload-area" id="upload-area">
                        <div class="upload-icon">ğŸ“</div>
                        <h3>PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</h3>
                        <p>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã€ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                            å¯¾å¿œå½¢å¼: .pdf (æœ€å¤§50MB)
                        </p>
                        <input type="file" id="pdf-file" class="file-input" accept=".pdf">
                    </div>
                    <div id="selected-file" class="selected-file"></div>
                </div>
                
                <div class="settings-card">
                    <h2 class="card-title">âš™ï¸ æŠ½å‡ºè¨­å®š</h2>
                    
                    <div class="settings-group">
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>è§£åƒåº¦å€ç‡</span>
                                <span id="resolution-value" class="slider-value">3.0å€</span>
                            </div>
                            <input type="range" id="resolution-slider" min="1" max="4" step="0.5" value="3">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>è‡ªå‹•ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°</span>
                                <span id="padding-value" class="slider-value">10px</span>
                            </div>
                            <input type="range" id="padding-slider" min="0" max="30" step="1" value="10">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>æ¤œå‡ºæ„Ÿåº¦</span>
                                <span id="sensitivity-value" class="slider-value">ä¸­</span>
                            </div>
                            <input type="range" id="sensitivity-slider" min="1" max="5" step="1" value="3">
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="auto-detect" checked>
                        <label for="auto-detect">ã‚¯ãƒªãƒƒã‚¯ã§è‡ªå‹•æ¤œå‡º</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="remove-bg" checked>
                        <label for="remove-bg">èƒŒæ™¯ã‚’é€æ˜åŒ–</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="smart-naming" checked>
                        <label for="smart-naming">è‡ªå‹•å‘½åã‚’æœ‰åŠ¹åŒ–</label>
                    </div>
                </div>
            </div>
            
            <div class="status-panel" id="status-panel">
                <div class="status-header">
                    <div class="status-title" id="status-title">æº–å‚™ä¸­...</div>
                    <div class="status-progress" id="status-progress">0%</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button id="load-pdf-btn" class="btn btn-primary" disabled>
                    <span>ğŸš€</span> PDFã‚’èª­ã¿è¾¼ã¿
                </button>
                <button id="auto-detect-all-btn" class="btn btn-info">
                    <span>ğŸ¤–</span> å…¨ã‚¢ã‚¤ã‚³ãƒ³è‡ªå‹•æ¤œå‡º
                </button>
                <button id="manual-select-btn" class="btn btn-warning">
                    <span>ğŸ¯</span> æ‰‹å‹•é¸æŠãƒ¢ãƒ¼ãƒ‰
                </button>
                <button id="extract-all-btn" class="btn btn-success">
                    <span>âœ‚ï¸</span> å…¨é¸æŠã‚’æŠ½å‡º
                </button>
            </div>
            
            <div class="global-controls">
                <div class="global-controls-title">ğŸ“¦ é¸æŠãƒœãƒƒã‚¯ã‚¹ç®¡ç†</div>
                <button id="fix-all-btn" class="global-btn">
                    <span>ğŸ“Œ</span> å…¨é¸æŠã‚’å›ºå®š
                </button>
                <button id="extract-selected-btn" class="global-btn extract">
                    <span>âœ‚ï¸</span> é¸æŠæ¸ˆã¿ã‚’æŠ½å‡º
                </button>
                <button id="clear-all-selections-btn" class="global-btn clear">
                    <span>ğŸ—‘ï¸</span> å…¨é¸æŠã‚’ã‚¯ãƒªã‚¢
                </button>
                
                <div class="selection-stats">
                    <div class="stat-item">
                        <div class="stat-badge active" id="active-count">0</div>
                        <span>èª¿æ•´ä¸­</span>
                    </div>
                    <div class="stat-item">
                        <div class="stat-badge fixed" id="fixed-count">0</div>
                        <span>å›ºå®šæ¸ˆã¿</span>
                    </div>
                    <div class="stat-item">
                        <div class="stat-badge completed" id="completed-count">0</div>
                        <span>æŠ½å‡ºæ¸ˆã¿</span>
                    </div>
                    <div class="stat-item">
                        <div class="stat-badge" id="total-count">0</div>
                        <span>åˆè¨ˆ</span>
                    </div>
                </div>
            </div>
            
            <div class="batch-name-edit">
                <div class="batch-name-label">ğŸ“ ä¸€æ‹¬å‘½å:</div>
                <input type="text" id="batch-name-input" class="batch-name-input" 
                       placeholder="ä¾‹: æ¨™è­˜_{ç•ªå·} (å…¨ã‚¢ã‚¤ã‚³ãƒ³ã«é©ç”¨ã•ã‚Œã¾ã™)">
                <button id="batch-name-apply-btn" class="batch-name-btn">ä¸€æ‹¬é©ç”¨</button>
            </div>
            
            <div class="hint-box">
                <div class="hint-title">ğŸ¯ ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</div>
                <div class="hint-content">
                    <strong>1. è‡ªå‹•æ¤œå‡º:</strong> ã€Œå…¨ã‚¢ã‚¤ã‚³ãƒ³è‡ªå‹•æ¤œå‡ºã€ãƒœã‚¿ãƒ³ã§ãƒšãƒ¼ã‚¸å†…ã®æ¨™è­˜ã‚’ä¸€æ‹¬æ¤œå‡º<br>
                    <strong>2. èª¿æ•´:</strong> å„é¸æŠãƒœãƒƒã‚¯ã‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ãƒ»ãƒªã‚µã‚¤ã‚ºã—ã¦æ­£ç¢ºãªä½ç½®ã«<br>
                    <strong>3. å›ºå®š:</strong> èª¿æ•´å¾Œã€Œå›ºå®šã€ãƒœã‚¿ãƒ³ã§ç¢ºå®šï¼ˆé’è‰²ã«å¤‰åŒ–ï¼‰<br>
                    <strong>4. å‘½å:</strong> ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åå‰ã‚’å…¥åŠ›ãƒ»ç·¨é›†å¯èƒ½<br>
                    <strong>5. æŠ½å‡º:</strong> ã€Œå…¨é¸æŠã‚’æŠ½å‡ºã€ã§å›ºå®šæ¸ˆã¿ã®å…¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä¿å­˜
                </div>
            </div>
            
            <div class="content-area">
                <div class="pdf-section">
                    <div class="section-header">
                        <h3 class="section-title">ğŸ“„ PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                        <div style="font-size: 0.9rem; color: #666;">
                            <span id="selection-count">0å€‹ã®é¸æŠãƒœãƒƒã‚¯ã‚¹</span>
                        </div>
                    </div>
                    <div class="canvas-wrapper">
                        <div class="zoom-controls">
                            <button id="zoom-out-btn" class="zoom-btn">âˆ’</button>
                            <div id="zoom-level-display" class="zoom-level">100%</div>
                            <button id="zoom-in-btn" class="zoom-btn">+</button>
                        </div>
                        <canvas id="pdf-canvas"></canvas>
                    </div>
                    <div style="text-align: center; margin-top: 15px; color: #666; font-size: 0.95rem;">
                        ğŸ” <strong>è‡ªå‹•æ¤œå‡ºãƒœã‚¿ãƒ³</strong>ã§å…¨æ¨™è­˜ã‚’ä¸€æ‹¬é¸æŠ â†’ èª¿æ•´ â†’ å›ºå®š â†’ å‘½å â†’ æŠ½å‡º
                    </div>
                </div>
                
                <div class="icons-section">
                    <div class="section-header">
                        <h3 class="section-title">ğŸ¯ æŠ½å‡ºã•ã‚ŒãŸã‚¢ã‚¤ã‚³ãƒ³ <span id="icon-count" class="icon-count">(0å€‹)</span></h3>
                        <button id="clear-icons-btn" class="global-btn clear" style="padding: 8px 16px;">
                            <span>ğŸ—‘ï¸</span> å…¨ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                    
                    <div class="icon-grid-container">
                        <div class="icon-grid" id="icon-grid">
                            <div class="empty-state" id="empty-state">
                                <div class="empty-icon">ğŸ›‘</div>
                                <h3>æŠ½å‡ºã•ã‚ŒãŸã‚¢ã‚¤ã‚³ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                                <p>è‡ªå‹•æ¤œå‡ºãƒœã‚¿ãƒ³ã§é¸æŠãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¦æŠ½å‡ºã—ã¦ãã ã•ã„</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="icon-detail-panel" id="icon-detail-panel">
                        <div class="detail-header">
                            <h4 class="detail-title" id="detail-title">ã‚¢ã‚¤ã‚³ãƒ³è©³ç´°</h4>
                            <button id="close-detail" class="btn-icon">Ã—</button>
                        </div>
                        <div class="detail-content">
                            <div class="detail-preview">
                                <img id="detail-preview-img" class="detail-preview-img" src="" alt="">
                            </div>
                            <div class="detail-info">
                                <div class="detail-info-item">
                                    <span class="detail-label">ã‚¢ã‚¤ã‚³ãƒ³å</span>
                                    <span id="detail-name-display" class="detail-value">-</span>
                                    <div class="detail-name-edit">
                                        <input type="text" id="detail-name-input" class="detail-name-input" 
                                               placeholder="ã‚¢ã‚¤ã‚³ãƒ³åã‚’å…¥åŠ›">
                                        <button id="detail-name-save-btn" class="detail-name-btn">ä¿å­˜</button>
                                    </div>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-label">ã‚µã‚¤ã‚º</span>
                                    <span id="detail-size" class="detail-value">-</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-label">å…ƒã®ä½ç½®</span>
                                    <span id="detail-position" class="detail-value">-</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-label">é¸æŠç•ªå·</span>
                                    <span id="detail-selection-id" class="detail-value">-</span>
                                </div>
                                <div class="detail-actions">
                                    <button id="download-detail-btn" class="detail-btn detail-btn-primary">
                                        ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                    </button>
                                    <button id="rename-detail-btn" class="detail-btn">
                                        åå‰ã‚’ç·¨é›†
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Â© 2023 é“è·¯æ¨™è­˜æŠ½å‡ºãƒ„ãƒ¼ãƒ« | è‡ªå‹•æ¤œå‡º & åå‰ç·¨é›†æ©Ÿèƒ½æ­è¼‰</p>
            <p style="font-size: 0.9rem; margin-top: 8px; color: #888;">
                è‡ªå‹•æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  | å€‹åˆ¥åå‰å…¥åŠ› | ä¸€æ‹¬å‘½åæ©Ÿèƒ½ | é«˜ç²¾åº¦æŠ½å‡º
            </p>
        </footer>
    </div>

    <script>
        // çŠ¶æ…‹ç®¡ç†
        let pdfDoc = null;
        let currentPage = 1;
        let pdfScale = 3.0;
        let zoomLevel = 1.0;
        let isProcessing = false;
        let extractedIcons = [];
        let selectedIconIndex = -1;
        let editingIconId = null;
        
        // è¤‡æ•°é¸æŠãƒœãƒƒã‚¯ã‚¹ç®¡ç†
        let selections = [];
        let activeSelectionId = null;
        let isManualSelectionMode = false;
        let isDraggingSelection = false;
        let isResizingSelection = false;
        let dragStartX = 0, dragStartY = 0;
        let resizeDirection = '';
        let selectionCounter = 1;
        
        // è¨­å®šå€¤
        let resolution = 3.0;
        let padding = 10;
        let sensitivity = 3;
        let autoDetect = true;
        let removeBg = true;
        let smartNaming = true;
        
        // DOMè¦ç´ 
        const pdfFileInput = document.getElementById('pdf-file');
        const uploadArea = document.getElementById('upload-area');
        const selectedFileDiv = document.getElementById('selected-file');
        const statusPanel = document.getElementById('status-panel');
        const statusTitle = document.getElementById('status-title');
        const statusProgress = document.getElementById('status-progress');
        const progressFill = document.getElementById('progress-fill');
        const loadPdfBtn = document.getElementById('load-pdf-btn');
        const autoDetectAllBtn = document.getElementById('auto-detect-all-btn');
        const manualSelectBtn = document.getElementById('manual-select-btn');
        const extractAllBtn = document.getElementById('extract-all-btn');
        const fixAllBtn = document.getElementById('fix-all-btn');
        const extractSelectedBtn = document.getElementById('extract-selected-btn');
        const clearAllSelectionsBtn = document.getElementById('clear-all-selections-btn');
        const clearIconsBtn = document.getElementById('clear-icons-btn');
        const pdfCanvas = document.getElementById('pdf-canvas');
        const canvasWrapper = document.querySelector('.canvas-wrapper');
        const iconGrid = document.getElementById('icon-grid');
        const iconCount = document.getElementById('icon-count');
        const selectionCount = document.getElementById('selection-count');
        const emptyState = document.getElementById('empty-state');
        const iconDetailPanel = document.getElementById('icon-detail-panel');
        const detailPreviewImg = document.getElementById('detail-preview-img');
        const detailNameDisplay = document.getElementById('detail-name-display');
        const detailNameInput = document.getElementById('detail-name-input');
        const detailNameSaveBtn = document.getElementById('detail-name-save-btn');
        const detailSize = document.getElementById('detail-size');
        const detailPosition = document.getElementById('detail-position');
        const detailSelectionId = document.getElementById('detail-selection-id');
        const downloadDetailBtn = document.getElementById('download-detail-btn');
        const renameDetailBtn = document.getElementById('rename-detail-btn');
        const closeDetailBtn = document.getElementById('close-detail');
        const batchNameInput = document.getElementById('batch-name-input');
        const batchNameApplyBtn = document.getElementById('batch-name-apply-btn');
        
        // çµ±è¨ˆè¡¨ç¤º
        const activeCount = document.getElementById('active-count');
        const fixedCount = document.getElementById('fixed-count');
        const completedCount = document.getElementById('completed-count');
        const totalCount = document.getElementById('total-count');
        
        // è¨­å®šã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
        const resolutionSlider = document.getElementById('resolution-slider');
        const paddingSlider = document.getElementById('padding-slider');
        const sensitivitySlider = document.getElementById('sensitivity-slider');
        const resolutionValue = document.getElementById('resolution-value');
        const paddingValue = document.getElementById('padding-value');
        const sensitivityValue = document.getElementById('sensitivity-value');
        const autoDetectCheck = document.getElementById('auto-detect');
        const removeBgCheck = document.getElementById('remove-bg');
        const smartNamingCheck = document.getElementById('smart-naming');
        
        // ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const zoomLevelDisplay = document.getElementById('zoom-level-display');
        
        // ==================== åˆæœŸåŒ– ====================
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã®è¨­å®š
        uploadArea.addEventListener('click', function() {
            pdfFileInput.click();
        });
        
        pdfFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                selectedFileDiv.innerHTML = `
                    <strong>é¸æŠãƒ•ã‚¡ã‚¤ãƒ«:</strong> ${file.name}<br>
                    <strong>ã‚µã‚¤ã‚º:</strong> ${fileSize} MB<br>
                    <strong>è§£åƒåº¦è¨­å®š:</strong> ${resolution}å€ã§èª­ã¿è¾¼ã¿ã¾ã™
                `;
                loadPdfBtn.disabled = false;
                
                uploadArea.style.borderColor = '#00b894';
                uploadArea.querySelector('.upload-icon').textContent = 'âœ…';
            }
        });
        
        // è¨­å®šã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®åˆæœŸåŒ–
        resolutionSlider.addEventListener('input', function() {
            resolution = parseFloat(this.value);
            resolutionValue.textContent = resolution.toFixed(1) + 'å€';
        });
        
        paddingSlider.addEventListener('input', function() {
            padding = parseInt(this.value);
            paddingValue.textContent = padding + 'px';
        });
        
        sensitivitySlider.addEventListener('input', function() {
            sensitivity = parseInt(this.value);
            const labels = ['æœ€ä½', 'ä½', 'ä¸­', 'é«˜', 'æœ€é«˜'];
            sensitivityValue.textContent = labels[sensitivity - 1];
        });
        
        autoDetectCheck.addEventListener('change', function() {
            autoDetect = this.checked;
        });
        
        removeBgCheck.addEventListener('change', function() {
            removeBg = this.checked;
        });
        
        smartNamingCheck.addEventListener('change', function() {
            smartNaming = this.checked;
        });
        
        // ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        zoomInBtn.addEventListener('click', zoomIn);
        zoomOutBtn.addEventListener('click', zoomOut);
        
        function zoomIn() {
            zoomLevel = Math.min(zoomLevel * 1.2, 5.0);
            updateCanvasZoom();
        }
        
        function zoomOut() {
            zoomLevel = Math.max(zoomLevel / 1.2, 0.2);
            updateCanvasZoom();
        }
        
        function updateCanvasZoom() {
            const zoomPercent = Math.round(zoomLevel * 100);
            zoomLevelDisplay.textContent = zoomPercent + '%';
            
            if (pdfCanvas.width > 0 && pdfCanvas.height > 0) {
                pdfCanvas.style.transform = `scale(${zoomLevel})`;
                pdfCanvas.style.transformOrigin = 'top left';
                
                const scaledWidth = pdfCanvas.width * zoomLevel;
                const scaledHeight = pdfCanvas.height * zoomLevel;
                canvasWrapper.style.minWidth = scaledWidth + 'px';
                canvasWrapper.style.minHeight = scaledHeight + 'px';
                
                updateAllSelectionsPosition();
            }
        }
        
        // ==================== PDFæ“ä½œ ====================
        
        // PDFèª­ã¿è¾¼ã¿
        loadPdfBtn.addEventListener('click', async function() {
            const file = pdfFileInput.files[0];
            if (!file) {
                alert('ã¾ãšPDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            setStatus('PDFã‚’èª­ã¿è¾¼ã¿ä¸­...', 10);
            loadPdfBtn.disabled = true;
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                setStatus(`è§£åƒåº¦${resolution}å€ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­...`, 40);
                pdfScale = resolution;
                await renderPDFPage(currentPage);
                
                setStatus('æº–å‚™å®Œäº†ï¼è‡ªå‹•æ¤œå‡ºãƒœã‚¿ãƒ³ã§å…¨æ¨™è­˜ã‚’æ¤œå‡ºã§ãã¾ã™', 100);
                setTimeout(() => {
                    setStatus('', 0, false);
                }, 2000);
                
                autoDetectAllBtn.disabled = false;
                manualSelectBtn.disabled = false;
                loadPdfBtn.disabled = false;
                
            } catch (error) {
                console.error('PDFèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                setStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 0);
                loadPdfBtn.disabled = false;
                setTimeout(() => {
                    setStatus('', 0, false);
                }, 3000);
            }
        });
        
        // PDFãƒšãƒ¼ã‚¸ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        async function renderPDFPage(pageNum) {
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: pdfScale });
            
            pdfCanvas.width = viewport.width;
            pdfCanvas.height = viewport.height;
            
            const context = pdfCanvas.getContext('2d');
            context.imageSmoothingEnabled = true;
            context.imageSmoothingQuality = 'high';
            
            context.fillStyle = 'white';
            context.fillRect(0, 0, pdfCanvas.width, pdfCanvas.height);
            
            await page.render({
                canvasContext: context,
                viewport: viewport
            }).promise;
            
            setupCanvasClickDetection();
            updateCanvasZoom();
            centerCanvas();
            
            clearAllSelections();
        }
        
        function centerCanvas() {
            canvasWrapper.scrollLeft = (pdfCanvas.width * zoomLevel - canvasWrapper.clientWidth) / 2;
            canvasWrapper.scrollTop = (pdfCanvas.height * zoomLevel - canvasWrapper.clientHeight) / 2;
        }
        
        // ==================== è‡ªå‹•æ¤œå‡ºæ©Ÿèƒ½ ====================
        
        // å…¨ã‚¢ã‚¤ã‚³ãƒ³è‡ªå‹•æ¤œå‡ºãƒœã‚¿ãƒ³
        autoDetectAllBtn.addEventListener('click', async function() {
            if (!pdfDoc || isProcessing) return;
            
            setStatus('å…¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’è‡ªå‹•æ¤œå‡ºä¸­...', 10, true);
            isProcessing = true;
            autoDetectAllBtn.disabled = true;
            
            try {
                clearAllSelections();
                
                const detectedIcons = await autoDetectAllIcons();
                
                setStatus(`${detectedIcons.length}å€‹ã®æ¨™è­˜ã‚’æ¤œå‡ºã—ã¾ã—ãŸ`, 60);
                
                detectedIcons.forEach((icon, index) => {
                    setTimeout(() => {
                        createSelectionBox(icon);
                    }, index * 100);
                });
                
                setStatus(`${detectedIcons.length}å€‹ã®é¸æŠãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¾ã—ãŸ`, 100);
                setTimeout(() => {
                    setStatus('', 0, false);
                }, 2000);
                
            } catch (error) {
                console.error('è‡ªå‹•æ¤œå‡ºã‚¨ãƒ©ãƒ¼:', error);
                setStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 0);
                setTimeout(() => {
                    setStatus('', 0, false);
                }, 3000);
            } finally {
                isProcessing = false;
                autoDetectAllBtn.disabled = false;
            }
        });
        
        // è‡ªå‹•å…¨ã‚¢ã‚¤ã‚³ãƒ³æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
        async function autoDetectAllIcons() {
            const ctx = pdfCanvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, pdfCanvas.width, pdfCanvas.height);
            const data = imageData.data;
            
            const visited = new Array(pdfCanvas.width * pdfCanvas.height).fill(false);
            const icons = [];
            
            // æ„Ÿåº¦ã«åŸºã¥ãã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º
            const gridSize = sensitivity === 1 ? 50 : sensitivity === 2 ? 40 : 
                           sensitivity === 3 ? 30 : sensitivity === 4 ? 20 : 15;
            
            // æ„Ÿåº¦ã«åŸºã¥ãã—ãã„å€¤
            const minSize = sensitivity === 1 ? 40 : sensitivity === 2 ? 30 : 
                          sensitivity === 3 ? 20 : sensitivity === 4 ? 15 : 10;
            const maxSize = sensitivity === 1 ? 400 : sensitivity === 2 ? 300 : 
                          sensitivity === 3 ? 250 : sensitivity === 4 ? 200 : 150;
            
            for (let y = gridSize; y < pdfCanvas.height - gridSize; y += gridSize) {
                for (let x = gridSize; x < pdfCanvas.width - gridSize; x += gridSize) {
                    const idx = (y * pdfCanvas.width + x) * 4;
                    const r = data[idx];
                    const g = data[idx + 1];
                    const b = data[idx + 2];
                    
                    if (!(r > 240 && g > 240 && b > 240) && !visited[y * pdfCanvas.width + x]) {
                        const bounds = floodFillDetection(x, y, imageData);
                        
                        if (bounds && bounds.pixelCount > 30 && 
                            bounds.width > minSize && bounds.height > minSize &&
                            bounds.width < maxSize && bounds.height < maxSize) {
                            
                            const isOverlap = icons.some(icon => 
                                Math.abs(icon.x - bounds.minX) < 50 && 
                                Math.abs(icon.y - bounds.minY) < 50
                            );
                            
                            if (!isOverlap) {
                                const iconPadding = padding;
                                const width = bounds.width + iconPadding * 2;
                                const height = bounds.height + iconPadding * 2;
                                
                                // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ãƒã‚§ãƒƒã‚¯ï¼ˆæ¥µç«¯ã«æ¨ªé•·ãƒ»ç¸¦é•·ã‚’é™¤å¤–ï¼‰
                                const aspectRatio = width / height;
                                if (aspectRatio > 0.3 && aspectRatio < 3.0) {
                                    icons.push({
                                        x: Math.max(0, bounds.minX - iconPadding),
                                        y: Math.max(0, bounds.minY - iconPadding),
                                        width: Math.min(pdfCanvas.width - (bounds.minX - iconPadding), width),
                                        height: Math.min(pdfCanvas.height - (bounds.minY - iconPadding), height)
                                    });
                                }
                            }
                        }
                    }
                }
            }
            
            return icons;
        }
        
        // æ´ªæ°´å……å¡«æ¤œå‡º
        function floodFillDetection(startX, startY, imageData) {
            const data = imageData.data;
            const visited = new Array(pdfCanvas.width * pdfCanvas.height).fill(false);
            const stack = [[Math.floor(startX), Math.floor(startY)]];
            
            const startIdx = (Math.floor(startY) * pdfCanvas.width + Math.floor(startX)) * 4;
            const startR = data[startIdx];
            const startG = data[startIdx + 1];
            const startB = data[startIdx + 2];
            
            let minX = startX, maxX = startX, minY = startY, maxY = startY;
            let pixelCount = 0;
            const maxPixels = sensitivity === 1 ? 10000 : sensitivity === 2 ? 8000 : 
                            sensitivity === 3 ? 6000 : sensitivity === 4 ? 4000 : 2000;
            
            while (stack.length > 0 && pixelCount < maxPixels) {
                const [x, y] = stack.pop();
                const idx = y * pdfCanvas.width + x;
                
                if (x < 0 || x >= pdfCanvas.width || y < 0 || y >= pdfCanvas.height || visited[idx]) {
                    continue;
                }
                
                const pixelIdx = idx * 4;
                const r = data[pixelIdx];
                const g = data[pixelIdx + 1];
                const b = data[pixelIdx + 2];
                
                if (r > 250 && g > 250 && b > 250) {
                    visited[idx] = true;
                    continue;
                }
                
                const colorDiff = Math.abs(r - startR) + Math.abs(g - startG) + Math.abs(b - startB);
                const threshold = sensitivity === 1 ? 100 : sensitivity === 2 ? 80 : 
                                sensitivity === 3 ? 60 : sensitivity === 4 ? 40 : 20;
                
                if (colorDiff > threshold) {
                    visited[idx] = true;
                    continue;
                }
                
                visited[idx] = true;
                pixelCount++;
                
                minX = Math.min(minX, x);
                maxX = Math.max(maxX, x);
                minY = Math.min(minY, y);
                maxY = Math.max(maxY, y);
                
                for (let dy = -1; dy <= 1; dy++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        if (dx === 0 && dy === 0) continue;
                        stack.push([x + dx, y + dy]);
                    }
                }
            }
            
            if (pixelCount < 30) return null;
            
            return {
                minX, maxX, minY, maxY,
                width: maxX - minX,
                height: maxY - minY,
                pixelCount
            };
        }
        
        // ==================== é¸æŠãƒœãƒƒã‚¯ã‚¹æ©Ÿèƒ½ ====================
        
        function setupCanvasClickDetection() {
            pdfCanvas.removeEventListener('click', handleCanvasClick);
            pdfCanvas.addEventListener('click', handleCanvasClick);
            pdfCanvas.style.cursor = 'crosshair';
        }
        
        async function handleCanvasClick(e) {
            if (isProcessing || isManualSelectionMode) return;
            
            const rect = pdfCanvas.getBoundingClientRect();
            const scaleX = pdfCanvas.width / rect.width;
            const scaleY = pdfCanvas.height / rect.height;
            const clickX = (e.clientX - rect.left) * scaleX / zoomLevel;
            const clickY = (e.clientY - rect.top) * scaleY / zoomLevel;
            
            setStatus('é¸æŠãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆä¸­...', 30, true);
            isProcessing = true;
            
            try {
                let selectionData;
                
                if (autoDetect) {
                    selectionData = await detectIconAtPoint(clickX, clickY);
                    if (!selectionData) {
                        selectionData = {
                            x: clickX - 50,
                            y: clickY - 50,
                            width: 100,
                            height: 100
                        };
                    }
                } else {
                    selectionData = {
                        x: clickX - 50,
                        y: clickY - 50,
                        width: 100,
                        height: 100
                    };
                }
                
                createSelectionBox(selectionData);
                
                setStatus('é¸æŠãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¾ã—ãŸï¼', 100);
                setTimeout(() => {
                    setStatus('', 0, false);
                }, 1500);
                
            } catch (error) {
                console.error('é¸æŠãƒœãƒƒã‚¯ã‚¹ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                setStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 0);
                setTimeout(() => {
                    setStatus('', 0, false);
                }, 2000);
            } finally {
                isProcessing = false;
            }
        }
        
        async function detectIconAtPoint(x, y) {
            const ctx = pdfCanvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, pdfCanvas.width, pdfCanvas.height);
            const data = imageData.data;
            
            const startIdx = (Math.floor(y) * pdfCanvas.width + Math.floor(x)) * 4;
            const startR = data[startIdx];
            const startG = data[startIdx + 1];
            const startB = data[startIdx + 2];
            
            if (startR > 240 && startG > 240 && startB > 240) {
                const found = findNearestNonWhite(x, y, imageData, 50);
                if (found) {
                    x = found.x;
                    y = found.y;
                }
            }
            
            const bounds = floodFillDetection(x, y, imageData);
            
            if (!bounds || bounds.width < 15 || bounds.height < 15) {
                return null;
            }
            
            const finalPadding = padding;
            
            return {
                x: Math.max(0, bounds.minX - finalPadding),
                y: Math.max(0, bounds.minY - finalPadding),
                width: Math.min(pdfCanvas.width - (bounds.minX - finalPadding), 
                               bounds.width + finalPadding * 2),
                height: Math.min(pdfCanvas.height - (bounds.minY - finalPadding), 
                                bounds.height + finalPadding * 2)
            };
        }
        
        function findNearestNonWhite(centerX, centerY, imageData, radius) {
            const data = imageData.data;
            
            for (let r = 1; r <= radius; r++) {
                for (let angle = 0; angle < Math.PI * 2; angle += Math.PI / 8) {
                    const x = Math.floor(centerX + Math.cos(angle) * r);
                    const y = Math.floor(centerY + Math.sin(angle) * r);
                    
                    if (x < 0 || x >= pdfCanvas.width || y < 0 || y >= pdfCanvas.height) continue;
                    
                    const idx = (y * pdfCanvas.width + x) * 4;
                    const rVal = data[idx];
                    const g = data[idx + 1];
                    const b = data[idx + 2];
                    
                    if (!(rVal > 240 && g > 240 && b > 240)) {
                        return { x, y };
                    }
                }
            }
            return null;
        }
        
        // é¸æŠãƒœãƒƒã‚¯ã‚¹ä½œæˆ
        function createSelectionBox(selectionData) {
            const selectionId = `selection-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const selectionNumber = selectionCounter++;
            
            const selectionBox = document.createElement('div');
            selectionBox.className = 'selection-box active';
            selectionBox.id = selectionId;
            selectionBox.dataset.id = selectionId;
            selectionBox.dataset.number = selectionNumber;
            selectionBox.dataset.state = 'active';
            
            selectionBox.style.left = (selectionData.x / zoomLevel) + 'px';
            selectionBox.style.top = (selectionData.y / zoomLevel) + 'px';
            selectionBox.style.width = (selectionData.width / zoomLevel) + 'px';
            selectionBox.style.height = (selectionData.height / zoomLevel) + 'px';
            
            const counter = document.createElement('div');
            counter.className = 'selection-counter';
            counter.textContent = selectionNumber;
            selectionBox.appendChild(counter);
            
            const controls = document.createElement('div');
            controls.className = 'selection-controls';
            
            const fixBtn = document.createElement('button');
            fixBtn.className = 'selection-btn fix';
            fixBtn.textContent = 'å›ºå®š';
            fixBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                fixSelection(selectionId);
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'selection-btn delete';
            deleteBtn.textContent = 'å‰Šé™¤';
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                deleteSelection(selectionId);
            });
            
            controls.appendChild(fixBtn);
            controls.appendChild(deleteBtn);
            selectionBox.appendChild(controls);
            
            const info = document.createElement('div');
            info.className = 'selection-info';
            info.textContent = `${Math.round(selectionData.width)}Ã—${Math.round(selectionData.height)}px`;
            selectionBox.appendChild(info);
            
            const handles = ['nw', 'n', 'ne', 'w', 'e', 'sw', 's', 'se'];
            handles.forEach(pos => {
                const handle = document.createElement('div');
                handle.className = `selection-handle ${pos}`;
                handle.dataset.direction = pos;
                handle.addEventListener('mousedown', function(e) {
                    e.stopPropagation();
                    startResizeSelection(selectionId, e);
                });
                selectionBox.appendChild(handle);
            });
            
            selectionBox.addEventListener('mousedown', function(e) {
                if (!e.target.classList.contains('selection-handle') && 
                    !e.target.classList.contains('selection-btn')) {
                    activateSelection(selectionId);
                    startDragSelection(selectionId, e);
                }
            });
            
            selectionBox.addEventListener('click', function(e) {
                if (!e.target.classList.contains('selection-handle') && 
                    !e.target.classList.contains('selection-btn')) {
                    activateSelection(selectionId);
                }
            });
            
            canvasWrapper.appendChild(selectionBox);
            
            const selection = {
                id: selectionId,
                number: selectionNumber,
                state: 'active',
                x: selectionData.x,
                y: selectionData.y,
                width: selectionData.width,
                height: selectionData.height,
                element: selectionBox,
                controls: controls,
                info: info
            };
            
            selections.push(selection);
            activateSelection(selectionId);
            updateSelectionStats();
            updateSelectionCount();
            updateGlobalButtons();
            setupGlobalMouseEvents();
        }
        
        function activateSelection(selectionId) {
            selections.forEach(selection => {
                selection.element.classList.remove('active');
            });
            
            const selection = selections.find(s => s.id === selectionId);
            if (selection) {
                selection.element.classList.add('active');
                activeSelectionId = selectionId;
            }
        }
        
        function fixSelection(selectionId) {
            const selection = selections.find(s => s.id === selectionId);
            if (selection && selection.state === 'active') {
                selection.state = 'fixed';
                selection.element.classList.remove('active');
                selection.element.classList.add('fixed');
                selection.element.dataset.state = 'fixed';
                
                const controls = selection.element.querySelector('.selection-controls');
                if (controls) {
                    controls.innerHTML = '';
                    
                    const extractBtn = document.createElement('button');
                    extractBtn.className = 'selection-btn complete';
                    extractBtn.textContent = 'æŠ½å‡º';
                    extractBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        extractSingleSelection(selectionId);
                    });
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'selection-btn delete';
                    deleteBtn.textContent = 'å‰Šé™¤';
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        deleteSelection(selectionId);
                    });
                    
                    controls.appendChild(extractBtn);
                    controls.appendChild(deleteBtn);
                }
                
                updateSelectionStats();
                updateGlobalButtons();
            }
        }
        
        function extractSingleSelection(selectionId) {
            const selection = selections.find(s => s.id === selectionId);
            if (!selection) return;
            
            setStatus('é¸æŠã‚’æŠ½å‡ºä¸­...', 30, true);
            
            try {
                const iconData = extractIconFromSelection(selection);
                
                // è‡ªå‹•å‘½å
                let iconName = `æ¨™è­˜_${selection.number}`;
                if (smartNaming) {
                    iconName = generateSmartName(iconData, selection.number);
                }
                
                addExtractedIcon(iconData, iconName);
                
                selection.state = 'completed';
                selection.element.classList.remove('fixed');
                selection.element.classList.add('completed');
                selection.element.dataset.state = 'completed';
                
                const controls = selection.element.querySelector('.selection-controls');
                if (controls) {
                    controls.style.display = 'none';
                }
                
                setStatus('é¸æŠã‚’æŠ½å‡ºã—ã¾ã—ãŸï¼', 100);
                setTimeout(() => {
                    setStatus('', 0, false);
                }, 1500);
                
                updateSelectionStats();
                
            } catch (error) {
                console.error('å˜ä¸€æŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
                setStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 0);
                setTimeout(() => {
                    setStatus('', 0, false);
                }, 2000);
            }
        }
        
        function generateSmartName(iconData, selectionNumber) {
            const { width, height } = iconData;
            const aspectRatio = width / height;
            
            let shape = '';
            if (aspectRatio > 0.9 && aspectRatio < 1.1) {
                shape = 'æ­£æ–¹å½¢';
            } else if (aspectRatio > 1.5) {
                shape = 'æ¨ªé•·';
            } else if (aspectRatio < 0.67) {
                shape = 'ç¸¦é•·';
            } else if (aspectRatio > 1.1 && aspectRatio <= 1.5) {
                shape = 'é•·æ–¹å½¢';
            } else {
                shape = 'æ¨™æº–';
            }
            
            const sizeCategory = width * height < 5000 ? 'å°' : 
                               width * height < 20000 ? 'ä¸­' : 'å¤§';
            
            return `æ¨™è­˜_${selectionNumber}_${shape}_${sizeCategory}`;
        }
        
        function deleteSelection(selectionId) {
            const selectionIndex = selections.findIndex(s => s.id === selectionId);
            if (selectionIndex !== -1) {
                const selection = selections[selectionIndex];
                
                if (selection.element && selection.element.parentNode) {
                    selection.element.remove();
                }
                
                selections.splice(selectionIndex, 1);
                
                if (activeSelectionId === selectionId) {
                    activeSelectionId = null;
                }
                
                updateSelectionStats();
                updateSelectionCount();
                updateGlobalButtons();
            }
        }
        
        function startDragSelection(selectionId, e) {
            const selection = selections.find(s => s.id === selectionId);
            if (!selection) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            isDraggingSelection = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            
            const startX = selection.x;
            const startY = selection.y;
            
            const onMouseMove = function(e) {
                if (!isDraggingSelection) return;
                
                const deltaX = (e.clientX - dragStartX) * zoomLevel;
                const deltaY = (e.clientY - dragStartY) * zoomLevel;
                
                selection.x = Math.max(0, Math.min(
                    pdfCanvas.width - selection.width,
                    startX + deltaX
                ));
                selection.y = Math.max(0, Math.min(
                    pdfCanvas.height - selection.height,
                    startY + deltaY
                ));
                
                updateSelectionPosition(selection);
            };
            
            const onMouseUp = function() {
                isDraggingSelection = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                updateSelectionInfo(selection);
            };
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }
        
        function startResizeSelection(selectionId, e) {
            const selection = selections.find(s => s.id === selectionId);
            if (!selection) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            isResizingSelection = true;
            resizeDirection = e.target.dataset.direction;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            
            const startX = selection.x;
            const startY = selection.y;
            const startWidth = selection.width;
            const startHeight = selection.height;
            
            const onMouseMove = function(e) {
                if (!isResizingSelection) return;
                
                const deltaX = (e.clientX - dragStartX) * zoomLevel;
                const deltaY = (e.clientY - dragStartY) * zoomLevel;
                
                let newX = startX;
                let newY = startY;
                let newWidth = startWidth;
                let newHeight = startHeight;
                
                if (resizeDirection.includes('e')) {
                    newWidth = Math.max(20, startWidth + deltaX);
                }
                if (resizeDirection.includes('w')) {
                    const widthChange = Math.min(startWidth - 20, deltaX);
                    newX = startX + widthChange;
                    newWidth = startWidth - widthChange;
                }
                if (resizeDirection.includes('s')) {
                    newHeight = Math.max(20, startHeight + deltaY);
                }
                if (resizeDirection.includes('n')) {
                    const heightChange = Math.min(startHeight - 20, deltaY);
                    newY = startY + heightChange;
                    newHeight = startHeight - heightChange;
                }
                
                selection.x = Math.max(0, Math.min(
                    pdfCanvas.width - 20,
                    newX
                ));
                selection.y = Math.max(0, Math.min(
                    pdfCanvas.height - 20,
                    newY
                ));
                selection.width = Math.max(20, Math.min(
                    pdfCanvas.width - selection.x,
                    newWidth
                ));
                selection.height = Math.max(20, Math.min(
                    pdfCanvas.height - selection.y,
                    newHeight
                ));
                
                updateSelectionPosition(selection);
            };
            
            const onMouseUp = function() {
                isResizingSelection = false;
                resizeDirection = '';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                updateSelectionInfo(selection);
            };
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }
        
        function updateSelectionPosition(selection) {
            if (!selection || !selection.element) return;
            
            selection.element.style.left = (selection.x / zoomLevel) + 'px';
            selection.element.style.top = (selection.y / zoomLevel) + 'px';
            selection.element.style.width = (selection.width / zoomLevel) + 'px';
            selection.element.style.height = (selection.height / zoomLevel) + 'px';
        }
        
        function updateAllSelectionsPosition() {
            selections.forEach(selection => {
                updateSelectionPosition(selection);
            });
        }
        
        function updateSelectionInfo(selection) {
            if (!selection || !selection.info) return;
            
            selection.info.textContent = `${Math.round(selection.width)}Ã—${Math.round(selection.height)}px`;
        }
        
        function updateSelectionStats() {
            const active = selections.filter(s => s.state === 'active').length;
            const fixed = selections.filter(s => s.state === 'fixed').length;
            const completed = selections.filter(s => s.state === 'completed').length;
            const total = selections.length;
            
            activeCount.textContent = active;
            fixedCount.textContent = fixed;
            completedCount.textContent = completed;
            totalCount.textContent = total;
            
            fixAllBtn.disabled = active === 0;
            extractAllBtn.disabled = fixed === 0 && active === 0;
            extractSelectedBtn.disabled = fixed === 0;
            clearAllSelectionsBtn.disabled = total === 0;
        }
        
        function updateSelectionCount() {
            selectionCount.textContent = `${selections.length}å€‹ã®é¸æŠãƒœãƒƒã‚¯ã‚¹`;
        }
        
        function updateGlobalButtons() {
            const hasFixed = selections.some(s => s.state === 'fixed');
            const hasActive = selections.some(s => s.state === 'active');
            
            extractAllBtn.disabled = !hasFixed && !hasActive;
            extractSelectedBtn.disabled = !hasFixed;
        }
        
        function setupGlobalMouseEvents() {
            document.removeEventListener('mousemove', handleGlobalMouseMove);
            document.removeEventListener('mouseup', handleGlobalMouseUp);
            
            document.addEventListener('mousemove', handleGlobalMouseMove);
            document.addEventListener('mouseup', handleGlobalMouseUp);
        }
        
        function handleGlobalMouseMove(e) {
            // å€‹åˆ¥ãƒªã‚¹ãƒŠãƒ¼ã§å‡¦ç†
        }
        
        function handleGlobalMouseUp() {
            isDraggingSelection = false;
            isResizingSelection = false;
            resizeDirection = '';
        }
        
        // ==================== ä¸€æ‹¬æ“ä½œ ====================
        
        fixAllBtn.addEventListener('click', function() {
            const activeSelections = selections.filter(s => s.state === 'active');
            activeSelections.forEach(selection => {
                fixSelection(selection.id);
            });
            
            setStatus(`${activeSelections.length}å€‹ã®é¸æŠã‚’å›ºå®šã—ã¾ã—ãŸ`, 100);
            setTimeout(() => {
                setStatus('', 0, false);
            }, 1500);
        });
        
        extractAllBtn.addEventListener('click', function() {
            const toExtract = selections.filter(s => s.state === 'fixed' || s.state === 'active');
            
            if (toExtract.length === 0) {
                alert('æŠ½å‡ºã™ã‚‹é¸æŠãƒœãƒƒã‚¯ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšé¸æŠãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆãƒ»å›ºå®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            setStatus(`${toExtract.length}å€‹ã®é¸æŠã‚’ä¸€æ‹¬æŠ½å‡ºä¸­...`, 10, true);
            isProcessing = true;
            
            let extractedCount = 0;
            
            toExtract.forEach((selection, index) => {
                setTimeout(() => {
                    try {
                        const iconData = extractIconFromSelection(selection);
                        
                        let iconName = `æ¨™è­˜_${selection.number}`;
                        if (smartNaming) {
                            iconName = generateSmartName(iconData, selection.number);
                        }
                        
                        addExtractedIcon(iconData, iconName);
                        
                        selection.state = 'completed';
                        selection.element.classList.remove('active', 'fixed');
                        selection.element.classList.add('completed');
                        selection.element.dataset.state = 'completed';
                        
                        const controls = selection.element.querySelector('.selection-controls');
                        if (controls) {
                            controls.style.display = 'none';
                        }
                        
                        extractedCount++;
                        
                        const progress = Math.round((extractedCount / toExtract.length) * 90) + 10;
                        setStatus(`${extractedCount}/${toExtract.length}å€‹ã‚’æŠ½å‡ºä¸­...`, progress);
                        
                        if (extractedCount === toExtract.length) {
                            setStatus(`${toExtract.length}å€‹ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ½å‡ºã—ã¾ã—ãŸï¼`, 100);
                            setTimeout(() => {
                                setStatus('', 0, false);
                            }, 2000);
                            isProcessing = false;
                            
                            updateSelectionStats();
                        }
                        
                    } catch (error) {
                        console.error(`é¸æŠ${selection.number}ã®æŠ½å‡ºã‚¨ãƒ©ãƒ¼:`, error);
                    }
                }, index * 300);
            });
        });
        
        extractSelectedBtn.addEventListener('click', function() {
            const fixedSelections = selections.filter(s => s.state === 'fixed');
            
            if (fixedSelections.length === 0) {
                alert('å›ºå®šæ¸ˆã¿ã®é¸æŠãƒœãƒƒã‚¯ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšé¸æŠãƒœãƒƒã‚¯ã‚¹ã‚’å›ºå®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            setStatus(`${fixedSelections.length}å€‹ã®å›ºå®šæ¸ˆã¿é¸æŠã‚’æŠ½å‡ºä¸­...`, 10, true);
            isProcessing = true;
            
            let extractedCount = 0;
            
            fixedSelections.forEach((selection, index) => {
                setTimeout(() => {
                    try {
                        const iconData = extractIconFromSelection(selection);
                        
                        let iconName = `æ¨™è­˜_${selection.number}`;
                        if (smartNaming) {
                            iconName = generateSmartName(iconData, selection.number);
                        }
                        
                        addExtractedIcon(iconData, iconName);
                        
                        selection.state = 'completed';
                        selection.element.classList.remove('fixed');
                        selection.element.classList.add('completed');
                        selection.element.dataset.state = 'completed';
                        
                        const controls = selection.element.querySelector('.selection-controls');
                        if (controls) {
                            controls.style.display = 'none';
                        }
                        
                        extractedCount++;
                        
                        const progress = Math.round((extractedCount / fixedSelections.length) * 90) + 10;
                        setStatus(`${extractedCount}/${fixedSelections.length}å€‹ã‚’æŠ½å‡ºä¸­...`, progress);
                        
                        if (extractedCount === fixedSelections.length) {
                            setStatus(`${fixedSelections.length}å€‹ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ½å‡ºã—ã¾ã—ãŸï¼`, 100);
                            setTimeout(() => {
                                setStatus('', 0, false);
                            }, 2000);
                            isProcessing = false;
                            
                            updateSelectionStats();
                        }
                        
                    } catch (error) {
                        console.error(`é¸æŠ${selection.number}ã®æŠ½å‡ºã‚¨ãƒ©ãƒ¼:`, error);
                    }
                }, index * 300);
            });
        });
        
        function extractIconFromSelection(selection) {
            const { x, y, width, height, number } = selection;
            
            const iconCanvas = document.createElement('canvas');
            iconCanvas.width = width;
            iconCanvas.height = height;
            const iconCtx = iconCanvas.getContext('2d');
            
            iconCtx.imageSmoothingEnabled = true;
            iconCtx.imageSmoothingQuality = 'high';
            
            iconCtx.drawImage(
                pdfCanvas,
                x, y, width, height,
                0, 0, width, height
            );
            
            if (removeBg) {
                removeBackground(iconCanvas);
            }
            
            return {
                x: Math.round(x),
                y: Math.round(y),
                width: Math.round(width),
                height: Math.round(height),
                imageData: iconCanvas.toDataURL('image/png', 1.0),
                timestamp: new Date().toLocaleTimeString(),
                selectionNumber: number
            };
        }
        
        function removeBackground(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                if (r > 240 && g > 240 && b > 240) {
                    data[i + 3] = 0;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        clearAllSelectionsBtn.addEventListener('click', function() {
            if (selections.length === 0) return;
            
            if (confirm(`${selections.length}å€‹ã®é¸æŠãƒœãƒƒã‚¯ã‚¹ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                clearAllSelections();
                setStatus('ã™ã¹ã¦ã®é¸æŠãƒœãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 100);
                setTimeout(() => {
                    setStatus('', 0, false);
                }, 1500);
            }
        });
        
        function clearAllSelections() {
            selections.forEach(selection => {
                if (selection.element && selection.element.parentNode) {
                    selection.element.remove();
                }
            });
            
            selections = [];
            activeSelectionId = null;
            selectionCounter = 1;
            
            updateSelectionStats();
            updateSelectionCount();
            updateGlobalButtons();
        }
        
        // ==================== ã‚¢ã‚¤ã‚³ãƒ³ç®¡ç† & åå‰ç·¨é›† ====================
        
        function addExtractedIcon(iconData, iconName = '') {
            const iconId = extractedIcons.length;
            iconData.id = iconId;
            iconData.name = iconName || `æ¨™è­˜_${iconId + 1}`;
            extractedIcons.push(iconData);
            
            emptyState.style.display = 'none';
            
            const iconElement = document.createElement('div');
            iconElement.className = 'icon-item';
            iconElement.dataset.id = iconId;
            
            iconElement.innerHTML = `
                <div class="icon-badge">${iconId + 1}</div>
                <img src="${iconData.imageData}" class="icon-img" alt="${iconData.name}">
                <div class="icon-name-container">
                    <div class="icon-name-display" id="icon-name-display-${iconId}">
                        ${iconData.name}
                    </div>
                    <input type="text" class="icon-name-input" id="icon-name-input-${iconId}" 
                           value="${iconData.name}" style="display: none;">
                    <button class="icon-name-edit-btn" onclick="startEditIconName(${iconId})">
                        åå‰ç·¨é›†
                    </button>
                    <div class="icon-size">${iconData.width}Ã—${iconData.height}px</div>
                </div>
            `;
            
            iconElement.addEventListener('click', function(e) {
                if (!e.target.classList.contains('icon-name-edit-btn') && 
                    !e.target.classList.contains('icon-name-input')) {
                    selectIcon(iconId);
                }
            });
            
            iconGrid.appendChild(iconElement);
            iconCount.textContent = `(${extractedIcons.length}å€‹)`;
            
            if (extractedIcons.length === 1) {
                selectIcon(0);
            }
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
        window.startEditIconName = function(iconId) {
            const iconElement = document.querySelector(`.icon-item[data-id="${iconId}"]`);
            if (!iconElement) return;
            
            const display = iconElement.querySelector(`#icon-name-display-${iconId}`);
            const input = iconElement.querySelector(`#icon-name-input-${iconId}`);
            const editBtn = iconElement.querySelector('.icon-name-edit-btn');
            
            if (!display || !input) return;
            
            display.style.display = 'none';
            input.style.display = 'block';
            input.focus();
            input.select();
            
            // ç·¨é›†ãƒœã‚¿ãƒ³ã‚’ä¿å­˜ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤‰æ›´
            editBtn.textContent = 'ä¿å­˜';
            editBtn.className = 'icon-name-edit-btn save';
            editBtn.onclick = function() {
                saveIconName(iconId);
            };
            
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            if (!iconElement.querySelector('.icon-name-edit-btn.cancel')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'icon-name-edit-btn cancel';
                cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
                cancelBtn.onclick = function() {
                    cancelEditIconName(iconId);
                };
                editBtn.parentNode.insertBefore(cancelBtn, editBtn.nextSibling);
            }
            
            editingIconId = iconId;
        };
        
        function saveIconName(iconId) {
            const iconElement = document.querySelector(`.icon-item[data-id="${iconId}"]`);
            if (!iconElement) return;
            
            const input = iconElement.querySelector(`#icon-name-input-${iconId}`);
            const display = iconElement.querySelector(`#icon-name-display-${iconId}`);
            const editBtn = iconElement.querySelector('.icon-name-edit-btn.save');
            const cancelBtn = iconElement.querySelector('.icon-name-edit-btn.cancel');
            
            if (!input || !display) return;
            
            const newName = input.value.trim();
            if (newName) {
                // ã‚¢ã‚¤ã‚³ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                const icon = extractedIcons[iconId];
                if (icon) {
                    icon.name = newName;
                }
                
                // è¡¨ç¤ºã‚’æ›´æ–°
                display.textContent = newName;
                
                // è©³ç´°ãƒ‘ãƒãƒ«ã‚‚æ›´æ–°
                if (selectedIconIndex === iconId) {
                    detailNameDisplay.textContent = newName;
                }
                
                setStatus('ã‚¢ã‚¤ã‚³ãƒ³åã‚’ä¿å­˜ã—ã¾ã—ãŸ', 100);
                setTimeout(() => {
                    setStatus('', 0, false);
                }, 1500);
            }
            
            // UIã‚’å…ƒã«æˆ»ã™
            input.style.display = 'none';
            display.style.display = 'block';
            
            if (editBtn) {
                editBtn.textContent = 'åå‰ç·¨é›†';
                editBtn.className = 'icon-name-edit-btn';
                editBtn.onclick = function() {
                    startEditIconName(iconId);
                };
            }
            
            if (cancelBtn) {
                cancelBtn.remove();
            }
            
            editingIconId = null;
        }
        
        function cancelEditIconName(iconId) {
            const iconElement = document.querySelector(`.icon-item[data-id="${iconId}"]`);
            if (!iconElement) return;
            
            const input = iconElement.querySelector(`#icon-name-input-${iconId}`);
            const display = iconElement.querySelector(`#icon-name-display-${iconId}`);
            const editBtn = iconElement.querySelector('.icon-name-edit-btn.save');
            const cancelBtn = iconElement.querySelector('.icon-name-edit-btn.cancel');
            
            if (!input || !display) return;
            
            // å…ƒã®åå‰ã«æˆ»ã™
            const icon = extractedIcons[iconId];
            if (icon) {
                input.value = icon.name;
            }
            
            // UIã‚’å…ƒã«æˆ»ã™
            input.style.display = 'none';
            display.style.display = 'block';
            
            if (editBtn) {
                editBtn.textContent = 'åå‰ç·¨é›†';
                editBtn.className = 'icon-name-edit-btn';
                editBtn.onclick = function() {
                    startEditIconName(iconId);
                };
            }
            
            if (cancelBtn) {
                cancelBtn.remove();
            }
            
            editingIconId = null;
        }
        
        function selectIcon(iconId) {
            if (editingIconId !== null && editingIconId !== iconId) {
                saveIconName(editingIconId);
            }
            
            document.querySelectorAll('.icon-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            const iconElement = document.querySelector(`.icon-item[data-id="${iconId}"]`);
            if (iconElement) {
                iconElement.classList.add('selected');
                selectedIconIndex = iconId;
                
                const icon = extractedIcons[iconId];
                
                detailPreviewImg.src = icon.imageData;
                detailNameDisplay.textContent = icon.name;
                detailNameInput.value = icon.name;
                detailSize.textContent = `${icon.width} Ã— ${icon.height} ãƒ”ã‚¯ã‚»ãƒ«`;
                detailPosition.textContent = `(${icon.x}, ${icon.y})`;
                detailSelectionId.textContent = icon.selectionNumber ? `é¸æŠ${icon.selectionNumber}` : 'ä¸æ˜';
                
                downloadDetailBtn.onclick = function() {
                    downloadIcon(iconId);
                };
                
                renameDetailBtn.onclick = function() {
                    startEditDetailName(iconId);
                };
                
                detailNameSaveBtn.onclick = function() {
                    saveDetailName(iconId);
                };
                
                iconDetailPanel.classList.add('active');
            }
        }
        
        function startEditDetailName(iconId) {
            const icon = extractedIcons[iconId];
            if (!icon) return;
            
            detailNameDisplay.style.display = 'none';
            detailNameInput.style.display = 'block';
            detailNameInput.focus();
            detailNameInput.select();
        }
        
        function saveDetailName(iconId) {
            const newName = detailNameInput.value.trim();
            if (!newName) return;
            
            const icon = extractedIcons[iconId];
            if (icon) {
                icon.name = newName;
                detailNameDisplay.textContent = newName;
                
                // ã‚°ãƒªãƒƒãƒ‰ã®è¡¨ç¤ºã‚‚æ›´æ–°
                const display = document.getElementById(`icon-name-display-${iconId}`);
                if (display) {
                    display.textContent = newName;
                }
                
                const input = document.getElementById(`icon-name-input-${iconId}`);
                if (input) {
                    input.value = newName;
                }
                
                setStatus('ã‚¢ã‚¤ã‚³ãƒ³åã‚’ä¿å­˜ã—ã¾ã—ãŸ', 100);
                setTimeout(() => {
                    setStatus('', 0, false);
                }, 1500);
            }
            
            detailNameInput.style.display = 'none';
            detailNameDisplay.style.display = 'block';
        }
        
        // ä¸€æ‹¬å‘½åæ©Ÿèƒ½
        batchNameApplyBtn.addEventListener('click', function() {
            const pattern = batchNameInput.value.trim();
            if (!pattern) {
                alert('å‘½åãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            let renamedCount = 0;
            
            extractedIcons.forEach((icon, index) => {
                const newName = pattern.replace('{ç•ªå·}', index + 1)
                                      .replace('{ç•ªå·2æ¡}', String(index + 1).padStart(2, '0'))
                                      .replace('{é¸æŠç•ªå·}', icon.selectionNumber || (index + 1))
                                      .replace('{å¹…}', icon.width)
                                      .replace('{é«˜ã•}', icon.height);
                
                icon.name = newName;
                renamedCount++;
                
                // ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºã‚’æ›´æ–°
                const display = document.getElementById(`icon-name-display-${index}`);
                if (display) {
                    display.textContent = newName;
                }
                
                const input = document.getElementById(`icon-name-input-${index}`);
                if (input) {
                    input.value = newName;
                }
                
                // è©³ç´°ãƒ‘ãƒãƒ«ã‚’æ›´æ–°
                if (selectedIconIndex === index) {
                    detailNameDisplay.textContent = newName;
                }
            });
            
            setStatus(`${renamedCount}å€‹ã®ã‚¢ã‚¤ã‚³ãƒ³åã‚’ä¸€æ‹¬æ›´æ–°ã—ã¾ã—ãŸ`, 100);
            setTimeout(() => {
                setStatus('', 0, false);
            }, 2000);
        });
        
        function downloadIcon(iconId) {
            const icon = extractedIcons[iconId];
            const link = document.createElement('a');
            const fileName = icon.name ? `${icon.name}_${icon.width}x${icon.height}.png` : 
                                       `é“è·¯æ¨™è­˜_${iconId + 1}_${icon.width}x${icon.height}.png`;
            link.download = fileName;
            link.href = icon.imageData;
            link.click();
        }
        
        clearIconsBtn.addEventListener('click', function() {
            if (extractedIcons.length === 0) return;
            
            if (confirm(`${extractedIcons.length}å€‹ã®æŠ½å‡ºæ¸ˆã¿ã‚¢ã‚¤ã‚³ãƒ³ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                extractedIcons = [];
                selectedIconIndex = -1;
                
                iconGrid.innerHTML = '';
                emptyState.style.display = 'block';
                iconDetailPanel.classList.remove('active');
                iconCount.textContent = '(0å€‹)';
                
                setStatus('ã™ã¹ã¦ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 100);
                setTimeout(() => {
                    setStatus('', 0, false);
                }, 1500);
            }
        });
        
        // ==================== ãã®ä»–ã®æ©Ÿèƒ½ ====================
        
        manualSelectBtn.addEventListener('click', function() {
            isManualSelectionMode = !isManualSelectionMode;
            
            if (isManualSelectionMode) {
                manualSelectBtn.innerHTML = '<span>ğŸ¯</span> è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚‹';
                pdfCanvas.style.cursor = 'crosshair';
                alert('æ‰‹å‹•é¸æŠãƒ¢ãƒ¼ãƒ‰: ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é¸æŠç¯„å›²ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ESCã‚­ãƒ¼ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‚');
            } else {
                manualSelectBtn.innerHTML = '<span>ğŸ¯</span> æ‰‹å‹•é¸æŠãƒ¢ãƒ¼ãƒ‰';
                pdfCanvas.style.cursor = '';
                alert('è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã—ãŸ');
            }
        });
        
        closeDetailBtn.addEventListener('click', function() {
            if (editingIconId !== null) {
                saveIconName(editingIconId);
            }
            iconDetailPanel.classList.remove('active');
        });
        
        function setStatus(message, progress, show = true) {
            statusTitle.textContent = message;
            statusProgress.textContent = progress + '%';
            progressFill.style.width = progress + '%';
            
            if (show) {
                statusPanel.classList.add('active');
            } else {
                statusPanel.classList.remove('active');
            }
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é“è·¯æ¨™è­˜æŠ½å‡ºãƒ„ãƒ¼ãƒ«ãŒèµ·å‹•ã—ã¾ã—ãŸ');
            
            resolutionValue.textContent = resolution + 'å€';
            paddingValue.textContent = padding + 'px';
            sensitivityValue.textContent = 'ä¸­';
            
            // åˆæœŸçŠ¶æ…‹ã§ã¯ä¸€éƒ¨ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            autoDetectAllBtn.disabled = true;
            manualSelectBtn.disabled = true;
            extractAllBtn.disabled = true;
        });
    </script>
</body>
</html>